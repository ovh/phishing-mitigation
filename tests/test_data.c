/*
 Copyright (C) 2016, OVH SAS

 This file is part of phishing-mitigation.

 phishing-mitigation is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
#include <string.h>
#include <stdio.h>
#include <stdlib.h>

#include "test_data.h"

uint8_t httpGetTcpData[] = {
0x45, 0x00, 0x00, 0xba, 0xa5, 0xc7, 0x40, 0x00, 0x40, 0x06, 0x7e, 0x72, 0x0a, 0xfe, 0x00, 0x08,  /* 0x000 E.....@.@.~r....*/
0x0a, 0xfe, 0x00, 0x01, 0x00, 0x50, 0xde, 0xfb, 0x48, 0x09, 0x9d, 0x98, 0x00, 0x00, 0x00, 0x00,  /* 0x010 .....P..H.......*/
0x80, 0x04, 0x00, 0x00, 0x1d, 0xd9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  /* 0x020 ................*/
0x00, 0x00, 0x00, 0x00, 0x47, 0x45, 0x54, 0x20, 0x2f, 0x69, 0x6e, 0x64, 0x65, 0x78, 0x2e, 0x68,  /* 0x030 ....GET./index.h*/
0x74, 0x6d, 0x6c, 0x3f, 0x74, 0x6f, 0x74, 0x6f, 0x3d, 0x31, 0x32, 0x33, 0x20, 0x48, 0x54, 0x54,  /* 0x040 tml?toto=123.HTT*/
0x50, 0x2f, 0x31, 0x2e, 0x31, 0x0d, 0x0a, 0x55, 0x73, 0x65, 0x72, 0x2d, 0x41, 0x67, 0x65, 0x6e,  /* 0x050 P/1.1..User-Agen*/
0x74, 0x3a, 0x20, 0x57, 0x67, 0x65, 0x74, 0x2f, 0x31, 0x2e, 0x31, 0x33, 0x2e, 0x34, 0x20, 0x28,  /* 0x060 t:.Wget/1.13.4.(*/
0x6c, 0x69, 0x6e, 0x75, 0x78, 0x2d, 0x67, 0x6e, 0x75, 0x29, 0x0d, 0x0a, 0x41, 0x63, 0x63, 0x65,  /* 0x070 linux-gnu)..Acce*/
0x70, 0x74, 0x3a, 0x20, 0x2a, 0x2f, 0x2a, 0x0d, 0x0a, 0x48, 0x6f, 0x73, 0x74, 0x3a, 0x20, 0x77,  /* 0x080 pt:.*.*..Host:.w*/
0x77, 0x77, 0x2e, 0x65, 0x78, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x2e, 0x63, 0x6f, 0x6d, 0x0d, 0x0a,  /* 0x090 ww.example.com..*/
0x43, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x3a, 0x20, 0x4b, 0x65, 0x65, 0x70,  /* 0x0a0 Connection:.Keep*/
0x2d, 0x41, 0x6c, 0x69, 0x76, 0x65, 0x0d, 0x0a, 0x0d, 0x0a                                       /* 0x0b0 -Alive....*/
};
uint32_t httpGetTcpDataLength = sizeof(httpGetTcpData);


uint8_t httpPutTcpData[] = {
0x45, 0x00, 0x00, 0xba, 0xa5, 0xc7, 0x40, 0x00, 0x40, 0x06, 0x7e, 0x72, 0x0a, 0xfe, 0x00, 0x08,  /* 0x000 E.....@.@.~r....*/
0x0a, 0xfe, 0x00, 0x01, 0x00, 0x50, 0xde, 0xfb, 0x48, 0x09, 0x9d, 0x98, 0x00, 0x00, 0x00, 0x00,  /* 0x010 .....P..H.......*/
0x80, 0x04, 0x00, 0x00, 0x1d, 0xd9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  /* 0x020 ................*/
0x00, 0x00, 0x00, 0x00, 0x50, 0x55, 0x54, 0x20, 0x2f, 0x69, 0x6e, 0x64, 0x65, 0x78, 0x2e, 0x68,  /* 0x030 ....PUT./index.h*/
0x74, 0x6d, 0x6c, 0x3f, 0x74, 0x6f, 0x74, 0x6f, 0x3d, 0x31, 0x32, 0x33, 0x20, 0x48, 0x54, 0x54,  /* 0x040 tml?toto=123.HTT*/
0x50, 0x2f, 0x31, 0x2e, 0x31, 0x0d, 0x0a, 0x55, 0x73, 0x65, 0x72, 0x2d, 0x41, 0x67, 0x65, 0x6e,  /* 0x050 P/1.1..User-Agen*/
0x74, 0x3a, 0x20, 0x57, 0x67, 0x65, 0x74, 0x2f, 0x31, 0x2e, 0x31, 0x33, 0x2e, 0x34, 0x20, 0x28,  /* 0x060 t:.Wget/1.13.4.(*/
0x6c, 0x69, 0x6e, 0x75, 0x78, 0x2d, 0x67, 0x6e, 0x75, 0x29, 0x0d, 0x0a, 0x41, 0x63, 0x63, 0x65,  /* 0x070 linux-gnu)..Acce*/
0x70, 0x74, 0x3a, 0x20, 0x2a, 0x2f, 0x2a, 0x0d, 0x0a, 0x48, 0x6f, 0x73, 0x74, 0x3a, 0x20, 0x77,  /* 0x080 pt:.*.*..Host:.w*/
0x77, 0x77, 0x2e, 0x65, 0x78, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x2e, 0x63, 0x6f, 0x6d, 0x0d, 0x0a,  /* 0x090 ww.example.com..*/
0x43, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x3a, 0x20, 0x4b, 0x65, 0x65, 0x70,  /* 0x0a0 Connection:.Keep*/
0x2d, 0x41, 0x6c, 0x69, 0x76, 0x65, 0x0d, 0x0a, 0x0d, 0x0a                                       /* 0x0b0 -Alive....*/
};
uint32_t httpPutTcpDataLength = sizeof(httpPutTcpData);

//16:30:13.280268 IP (tos 0x0, ttl 64, id 12094, offset 0, flags [DF], proto TCP (6), length 179)
//5.196.144.22.44287 > 198.27.92.1.80: Flags [P.], cksum 0xb89c (incorrect -> 0xa12e), seq 1:140, ack 1, win 14600, length 139
const char* httpGetPassThroughHeader_data = ""\
"0x0000:  4500 00b3 2f3e 4000 4006 5310 05c4 9016  E.../>@.@.S....."\
"0x0010:  c61b 5c01 acff 0050 b11e 94ee e59a 166e  .......P.......n"\
"0x0020:  5018 3908 b89c 0000 4745 5420 2f20 4854  P.9.....GET./.HT"\
"0x0030:  5450 2f31 2e31 0d0a 5573 6572 2d41 6765  TP/1.1..User-Age"\
"0x0040:  6e74 3a20 5767 6574 2f31 2e31 332e 3420  nt:.Wget/1.13.4."\
"0x0050:  286c 696e 7578 2d67 6e75 290d 0a41 6363  (linux-gnu)..Acc"\
"0x0060:  6570 743a 202a 2f2a 0d0a 486f 7374 3a20  ept:.*.*..Host:."\
"0x0070:  7777 772e 6f76 682e 636f 6d0d 0a43 6f6e  www.ovh.com..Con"\
"0x0080:  6e65 6374 696f 6e3a 204b 6565 702d 416c  nection:.Keep-Al"\
"0x0090:  6976 650d 0a58 2d46 6169 316f 6862 6f61  ive..X-Fai1ohboa"\
"0x00a0:  694c 7535 5468 6f3a 2066 6f6f 6261 720d  iLu5Tho:.foobar."\
"0x00b0:  0a0d 0a";

size_t tcmpdump_to_bin(const char* tcmpdump_arg, uint8_t** result)
{
  *result = NULL;
  size_t tcmpdump_len = strlen(tcmpdump_arg);
  uint8_t* buffer = malloc(tcmpdump_len);
  size_t buffer_index = 0;
  char* tcmpdump = strdup(tcmpdump_arg);
  char* dump_end = tcmpdump + tcmpdump_len;

  const char* starter = ":  ";
  char* line = strstr(tcmpdump, starter);
  while(line != NULL)
  {
    line += strlen(starter);
    char* begin = line;
    char* next_line = strstr(line, starter);
    char* end = next_line != NULL ? next_line : dump_end;
    char* tok = strtok(begin, " ");
    int tok_count = 0;
    while(tok != NULL && tok < end && tok_count < 8)
    {
      tok_count++;
      //printf("%s ", tok);
      uint32_t hex_val = strtol( tok, NULL, 16 );
      //printf("(%x) ", hex_val);

      if(strlen(tok)<4)
      {
        buffer[buffer_index++] = hex_val & 0xff;
      }
      else
      {
        buffer[buffer_index++] = (hex_val >> 8) & 0xff;
        buffer[buffer_index++] = hex_val & 0xff;
      }

      char* next_tok = strtok(NULL, " ");
      if(next_tok<tok) break; //break if next tok is null

      //break if more than 1 space after the 4 number
      //Should be "1234 " : len == 5
      //data line end with somthing like this : "1234  " : len==6
      if((next_tok-tok) > 5) break;

      tok = next_tok;
    }
    //printf("\n");
    line = next_line;
  }

  free(tcmpdump);
  *result = buffer;
  return buffer_index;
}
